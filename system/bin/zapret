#!/system/bin/sh

CONFIG_FILE="/data/adb/zapret/config"
export MODPATH="/data/adb/modules/zapret"
export HOSTLIST="--hostlist=$MODPATH/list/zapret-hosts.txt \
--hostlist-exclude=$MODPATH/list/zapret-hosts-exclude.txt \
--hostlist=/data/adb/zapret/zapret-hosts-user.txt \
--hostlist-exclude=/data/adb/zapret/zapret-hosts-user-exclude.txt \
--hostlist-auto=/data/adb/zapret/zapret-hosts-auto.txt \
--hostlist-auto-fail-threshold=3 \
--hostlist-auto-fail-time=60 \
--hostlist-auto-retrans-threshold=3"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "ERROR: Файл конфигурации не найден."
    exit 1
elif file "$CONFIG_FILE" | grep -q "CRLF"; then
    echo "ERROR: Файл конфигурации в CRLF!"
    exit 1
fi

# shellcheck disable=SC3046
# shellcheck disable=SC1090
source "$CONFIG_FILE"
NFQWS_OPT=$(echo "$NFQWS_OPT" | tr '\n' ' ')

start_service() {
    echo "Start service"
    setup_iptables

    if [ "$MARK_SUPPORT" -eq 1 ]; then
        mark_option="--dpi-desync-fwmark=0x40000000"
    fi

    # shellcheck disable=SC2086
    /system/bin/nfqws --debug=android --uid 0:3003 --daemon "$mark_option" --qnum=200 $NFQWS_OPT
}

stop_service() {
    echo "Stop service"
    kill "nfqws"
    clean_iptables
}

restart_service() {
    echo "Restart service"
    stop_service
    start_service
}

status_service() {
    echo "Status service"
    pgrep "nfqws"
}

setup_iptables() {
    connbytes_args=""
    mark_args=""

    if [ "$CONNBYTES_SUPPORT" -eq 1 ]; then
        connbytes_args="-m connbytes --connbytes-dir=original --connbytes-mode=packets --connbytes 1:6"
    fi

    if [ "$MARK_SUPPORT" -eq 1 ]; then
        mark_args="-m mark ! --mark 0x40000000/0x40000000"
    fi

    if [ "$MULTIPORT_SUPPORT" -eq 1 ]; then
        # shellcheck disable=SC2086
        iptables -t mangle -I POSTROUTING -p tcp -m multiport --dports "$NFQWS_PORTS_TCP" -j NFQUEUE $mark_args $connbytes_args --queue-num 200 --queue-bypass
        # shellcheck disable=SC2086
        iptables -t mangle -I POSTROUTING -p udp -m multiport --dports "$NFQWS_PORTS_UDP" -j NFQUEUE $mark_args $connbytes_args --queue-num 200 --queue-bypass
    else
        for port in $NFQWS_PORTS_TCP; do
            # shellcheck disable=SC2086
            iptables -t mangle -I POSTROUTING -p tcp --dport "$port" -j NFQUEUE $mark_args $connbytes_args --queue-num 200 --queue-bypass
        done

        for port in $NFQWS_PORTS_UDP; do
            # shellcheck disable=SC2086
            iptables -t mangle -I POSTROUTING -p udp --dport "$port" -j NFQUEUE $mark_args $connbytes_args --queue-num 200 --queue-bypass
        done
    fi
    sysctl -w net.netfilter.nf_conntrack_tcp_be_liberal=1
}

clean_iptables() {
    iptables -t mangle -F POSTROUTING
}

case "$1" in
start)
    start_service
    ;;
stop)
    stop_service
    ;;
enable)
    enable_service
    ;;
disable)
    disable_service
    ;;
restart)
    restart_service
    ;;
status)
    status_service
    ;;
*)
    echo "$HOSTLIST"
    echo "$NFQWS_PORTS_TCP"
    echo "$NFQWS_PORTS_UDP"
    echo "$NFQWS_OPT"
    ;;
esac
